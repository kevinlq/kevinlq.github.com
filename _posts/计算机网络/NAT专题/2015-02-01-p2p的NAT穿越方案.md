---
layout : life
title: P2P的NAT穿越方案
category : 计算机网络
duoshuo: true
date : 2015-02-02
---

<!-- more -->

******

### NAT专题之P2P的NAT穿越方案

#### ***1.P2P简介***

>
P2P即点对点通信，或称为对等联网，与传统的服务器客户端模式有着明显的区别，传统的服务器客户端模型如图2所示。P2P这一术语在不同的上下文环境里可能有不同的内涵，它可以指一种通信模式、一种逻辑网络模型、一种技术、甚至一种理念。在P2P网络中如图1所示，所有通信节点的地位都是对等的，每个节点都扮演着客户机和服务器双重角色，节点之间通过直接通信实现文件信息、处理器运算能力、存储空间等资源的共享。P2P网络具有分散性、可扩展性、健壮性等特点，这使得P2P技术在信息共享、实时通信、协同工作、分布式计算、网络存储等领域都有广阔的应用;

* ![P2P结构模型](/res/img/blog/计算机网络/2015-02-02-001.jpg)

***图1 P2P结构模型***

* ![CS模式](/res/img/blog/计算机网络/2015-02-02-002.jpg)

***图2 CS模式***

#### ***2.NAT简介***

目前,IPV4地址资源的紧缺使得NAT技术获得了广泛的应用，NAT技术是一种把内部网络(简称内网)私有IP地址转换为外部网络(简称为外网)公共IP地址的技术，它使得一定范围内的多台主机志李永一个公共IP地址链接到外网，可以在很大成都上缓解公网IP地址紧缺的问题。

#### ***3.NAT对P2P通信的影响***

NAT技术虽然在一定成都上解决了IPV4地址短缺的问题，在构建防火墙，保证网络安全方面都发挥了一定的作用，却破坏了端到段的网络通信，NAT阻碍朱姐进行p2p通信的主要原因时NAT不允许外网主机主动访问内网诸暨，因为NAT设备上没有先关转发表项，要在NAT网络环境中进行有效的p2p通信，就必须寻找相应的解决方案，本文就着重介绍几种常见的解决方案。

#### ***4.p2p穿越NAT的几种方案***

##### ***4.1 反向链接技术***

　　当通信双方中一方位于NAT之后时，他们可以利用反向链接技术来进行p2p通信，图中的clientA(拥有内网地址10.0.0.1)位于NAT之后，它通过TCP端口1234连接到服务器(拥有外网IP地址)的TCP端口1235上,NAT设备(拥有外网地址:155.99.25.11)味这个链接重新分配了TCP端口62000，clientB(拥有外网IP地址138.76.29.7)叶通过TCP端口1234连接到服务器1235上，clientA和clientB从服务器除货值的对网的外网地址二元组{IP地址:端口号}分别为{138.76.29.7:1234}和{155.99.25.11:62000}.他们在各自的本地端口上进行侦听。
　　由于clientB拥有外网IP地址，所以clientA可以直接通过TCP发起与clientB的链接，但如果clientB尝试通过TCP链接到clientA进行P2P通信，则会失败，原因是clientA位于NAT设备后，虽然clientB发出的TCP SYN请求能够到达NAT设备的端口62000，但NAT设备会拒绝这个链接请求，要想与clientA通信，clientB要通过服务器给clientA转发一个链接请求，反过来请求clientA连接到clientB(即进行反向链接),从而建立起他们之间的TCP链接。

* ![反向链接示意图](/res/img/blog/计算机网络/2015-02-02-003.jpg)

#### ***4.2 UDP打洞技术***

　　如果两个客户端窦唯与NAT设备后面，想要进行P2P通信，那又该如何解决呢?UDP打洞技术就是为解决这个问题应运而生的，它能够通过中间服务器实现P2P客户端互联，该技术在在线游戏协议中已经的到了应用

##### ***4.2.1集中服务器***

　　打洞技术嘉定客户端A和客户端B都可以与公网内的已知集中服务器建立UDP链接，一个客户端在集中服务器上登陆的时候，服务器记录下改客户端的两对地址二元组信息{IP地址:UDP端口}，一对是该客户端与集中服务器进行通信的自身的地址和端口号，另外一对是集中服务器记录下的由服务器观察到的改客户端实际与自己所使用的地址和端口号，我们可以把前一对地址二元组看作是客户端的内网地址和端口号，把后一对地址二元组看作是客户端的内网地址和端口号经过NAT转换后的外网地址和端口号，集中服务器可以从客户端的登录消息中的到客户端内网相关信息，还可以通过消息的IP头和UDP头得到改客户端的外网相关信息，如果该客户端不是位于NAT设备后面，那么采用上述方法得到的两对地址二元组信息是完全相同的。

##### ***4.2.2建立p2p session***

假定客户端A要发起客户端B的直接链接，具体的打洞过程如下:

* 客户端A最初不知道如何向客户端B发起链接，于是客户端A向集中服务器发送消息，请求集中服务器帮助建立与客户端B的UDP链接。
* 集中服务器将含有客户端B的外网和内网地址二元组发送给客户端A，同时，集中服务器将包含将包含有客户端A的外网和内网地址二元组信息发送给客户端B，这样以来,客户端A与客户端B就都知道对方外网和内网的地址二元组信息了。
* 当客户端A收到有集中服务器发来的包含客户端B的外网和内网的地址二元组信息后，客户端A开始向客户端B的地址二元组发送UDP数据包，并且客户端A会自动锁定第一个给出相应的客户端B的地址二元组，同理，当客户端B收到由集中服务器发来的客户端A的地址二元组信息后，也会开始向客户端A的外网和内网的地址二元组发送UDP数据包，并且　自动锁定第一个得到的客户端A回应的二元组，由于客户端A与客户端B互相向对方发送UDP数据包的操作是异步的，所以客户端A和客户端B发送数据包的时间先后没有时序要求。

下面来看下这三者之间时如何进行UDP打洞的,在这我们分三种具体情景来讨论：

* 两个客户端都唯一同一个NAT设备后面，即位于同一个内网中；
* 两个客户端分别位于不同的NAT设备后面，分属于不容的内网;
* 两个客户端位于两层NAT设备之后,通常最上层的NAT是由网络提供商提供的，第二层NAT时家用的NAT路由器之类的设备提供的；

##### ***4.2.3 p2p的两个客户端位于同一个NAT设备后面***

首先假设两个客户端位于同一个NAT后面，并且位于内网，如图所示，客户端A与集中服务器建立UDP链接，经过NAT转换后，A的公网端口被映射为62000，客户端B同样与集中服务器建立了UDP链接,公网端口映射为62005;

![位于同一个NAT设备后的UDP打洞过程](/res/img/blog/计算机网络/2015-02-02-004.png)

　　假设客户端A向通过集中服务器，发起对客户端B的链接，客户端A向集中服务器发出消息请求与客户端B进行链接，集中服务器将客户端B的外网地址二元组以及内网地址二元组发送给客户端A,同时把客户端A的相关二元组信息发给B，。客户端A和客户端B发往对方公网地址二元组兵一定会被对方收到，这取决于当前的NAT设备是否支持不同端口之间的UDP数据包能够到达，即`Harrpin`转换特性，无论如何客户端Ａ发往客户端B的内网地址二元组的UDP数据包一定可以到达，内网数据包不需要路由，且速度更快，客户端A与客户端B推荐采用内网地址二元组信息进行常规p2p通信。
　　假定NAT设备支持`Hairpin`转换，具体的`Hairpin`转换详见其他文章，应用程序也应该忽略与内网地址二元组的链接，如果客户端A和客户端B采用外网的地址二元组作为p2p通信的链接，这势必会造成数据包无谓的经过NAT设备，这是一种对资源的浪费，就目前的网络情况而言，应用程序在"打洞"的时候，最好还是把外网和内网地址二元组都尝试一下，如果都能成功，有限以内网地址进行链接。

##### ***4.2.4 P2P客户端位于不同NAT设备后面***

　　假定客户端A与客户端B在不容的NAT设备后面，分属于不同的内网，如图所示，客户端A与客户端B都经由个子的NAT设备与集中服务器建立了UDP链接，客户端A与客户端B的本地端口好均为4321，集中服务器的公网端口号为1234，在向外的回话中，客户端A的外网IP被映射为159.99.25.11，外网端口为62000，客户端B的外网IP被映射为138.76.29.7，外网端口为31000.

　　如下图所示：

* 客户端A -> 本地IP:10.0.0.1,本地端口4321,　外网IP:155.99.25.11,外网端口62000
* 客户端B -> 本地IP:10.1.1.3,本地端口4321,  外网IP:138.76.29.7, 外网端口31000

![位于不同的NAT设备后的UDP打洞过程](/res/img/blog/计算机网络/2015-02-02-005.png)

　　在客户端A或者B向集中服务器发送登陆消息时，服务器会记录下客户端的内外网的二元组信息，后期无论是A与B二者中的任何乙方向服务器发送P2P请求，服务器都会将记录下来的上述信息发送给A或B.
　　A,B分属于不同的内网，他们彼此的内网地址在外网中时没有路由的，所以发往各自内网地址的UDP数据包回发送到错误的主机或者根本不存在的主机上，现在假定A的第一个消息将发往B的外网地址，如图所示，该消息途径A的NAT设备，并在该设备上生成一个回话表项，该会话表项源地址二元组信息时{10.0.0.1:4321}，该地址二元组信息和客户端A与服务器建立连接的时候NAT生成的源地址二元组信息一样，但他的目的地址不同，如果A的NAT设备给出的响应是OK的，那么A的NAT设备将保留A的内网地址二元组信息，并且所有来自A的源地址二元组信息为{10.0.0.1:4321}的数据包都沿用A与集中服务器事先建立起来的回话，外网地址二元组信息均为{155.99.25.11:62000}.
　　A向B的外网地址发送消息的过程就是"打洞"的过程，从A的内网的角度来看应为从{10.0.0.1:4321}发往{138.76.29.7:31000},从A在其NAT设备上建立的回话来看，是从{155.99.25.11:62000}发到{138.76.29.7:31000}.
　　如果A发送给B的外网地址二元组的信息包在B向A发送消息包之前到达B的NAT设备，B的NAT设备会认为A发过来的消息是未授权的外网消息，会丢弃该数据包.B发往A的消息与上述过程一样，会在B的NAT设备上建立一个{10.1.1.3:4321,155.99.25.11:62000}的会话(通常也会沿用B与集中服务器链接时建立的会话，只是该会话现在不仅接受服务器发给B的消息，还接受从A的NAT设备155.99.25.11:62000发来的消息),一旦A与B都想对方的NAT设备在外网上的地址二元组发送了数据包，就打开了A与Ｂ之间的洞，A与B向对方的外网地址发送数据，等效为向对方的客户端直接发送UDP数据包了，一旦应用程序确认已经可以通过往对方的外网地址发送数据包的方式让数据到达NAT后面的目的应用程序，程序会自动停止继续发送用于打洞的数据包，转而开始真正的p2p数据传输；

##### ***4.2.5 P2P客户端位于多层NAT设备后面***

　　有的网络拓扑结构包含了多个NAT设备，如果没有掌握该拓扑结构的详细信息，两个客户端之间是无法建立"最优化"的P2P路由的，现在我们来讨论最后一种情况。如图所示，假定NAT　C是由ISP提供的NAT设备，NAT C提供多个用户节点映射到有限的几个公网IP的服务，NAT A和NAT B作为NAT C的内网节点将把用户的家庭网络或内部网络接入NAT C的内网，然后用户的内部网络就可以经由NAT C访问公网了，从这种拓扑结构来看，只有服务器与NAT　C时真正拥有公网可路由IP地址的设备，而NAT A和NAT B所使用的公网IP地址，实际上石油ISP服务提供商设定的(相对于NAT C而言)内网地址(本文的后续部分把这个由ISP提供的内网地址相对于NAT C称之为"伪"公网地址)，同理隶属于NAT A与NAT B的客户端,相对于NAT A,NAT B而言，他们处于NAT A,NAT B的内网，以此类推，客户端可以放到多层NAT设备后面，客户端A和客户端B发去对于服务器S的链接的时候，就会以此在NAT A和NAT B上建立向外的Session，而NAT A，NAT B要联入公网的时候，会在NAT C上在建立想歪的Session;

![多层NAT下的打洞过程](/res/img/blog/计算机网络/2015-02-02-006.png)

　　现在假定客户端A和B希望通过UDP"打洞"完成两个客户端的P2P直连，最优化的路由策略时客户端A向客户端B的伪公网IP上发送数据包，即ISP服务器提供商指定的内网IP,NAT B的伪公网地址二元组{10.0.1.2:55000},由于从服务器的角度只能观察到真正的公网地址，也就是 NAT A,NAT B在NAT C建立session的真正的公网地址{155.99.25.11:62000}以及{155.99.25.11:62005},非常不幸的时客户端A与客户端B是无法通过服务器知道这些伪公网地址，而且即使客户端A和B通过某种手段得到NAT A和NAT B的伪公网地址，我们仍然不建议采用上述的最优化的打洞方式，这是因为这些地址是由ISP服务器提供商提供的或许会存在与客户端本身所在的内网地址重复的可能性(例如：NAT A的内网的IP地址域恰好与NAT A 在NAT C的伪公网IP地址域重复，这样就导致打洞数据包无法发出的问题)，因此客户端别无选择，只能使用由公网服务器观察到的A,B二元组进行打洞操作，用于打洞的数据包将由NAT　C进行转发。
　　当客户端A向客户端B的公网地址二元组{155.99.25.11:62005}发送UDP数据包的时候，NAT A首先把数据包的源地址二元组由A的内网地址二元组{10.0.0.1:4321}转换为伪公网地址二元组{10.0.1.1:45000},现在数据包到了NAT C,NAT C应该可以是别处来该数据包是要发往自身转换过得公网地址二元组，如果NAT C可以给出"合理"相应的话，NAT C将把该数据包的源地址二元组改为{155.99.25.11:62000}，目的地址二元组改为{10.0.1.2:55000},即NAT B的"伪公网"地址二元组，NAT B最后会将数据包发往客户端B,同样，由B发往A的数据包也会经过类似的过程，目前也有很多NAT设备不支持类似这样的`Hairpin`转换，但是意境有越来越多的NAT设备商开始加入对该转换的支持中来。

##### ***4.2.6 UDP在空闲状态下的超时问题***

由于UDP转换协议提供的“洞”不是绝对可靠的，多数NAT设备内部都有一个UDP转换的空闲状态计时器，如果在一段时间内没有UDP数据通信，NAT设备会关掉由“打洞”操作打出来的“洞”，作为应用程序来讲如果想要做到与设备无关，就最好在穿越NAT以后设定一个穿越的有效期。
很遗憾目前没有标准有效期，这个有效期与NAT设备内部的配置有关，某些设备上最短的只有20秒左右。在这个有效期内，即使没有P2P数据包需要传输，应用程序为了维持该“洞”可以正常工作，也必须向对方发送“打洞”心跳包。这个心跳包是需要双方应用程序都发送的，只有一方发送不会维持另一方的Session正常工作。除了频繁发送“打洞”心跳包以外，还有一个方法就是在当前的“洞”超时之前，P2P客户端双方重新“打洞”，丢弃原有的“洞”，这也不失为一个有效的方法。


















